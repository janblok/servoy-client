
(function() {
        tinymce.create('tinymce.plugins.ResizeToContainer', {
                init : function(ed, url) {
                		var totalTime = 0;
                		
                        if (ed.getParam('fullscreen_is_enabled'))
                                return;

                        /**
                         * This method gets executed each time the editor needs to resize.
                         */
                        function resize() {
                        		var iframe = tinymce.DOM.get(ed.id + '_ifr');
                        		var extractHeight = 0;
                        		if (iframe)
                        		{
                        			if ($(iframe.parentNode.parentNode.childNodes[0]).find('button').height() != 20)
                            		{
                            			// avoid infinite cycle, loop only for 1 second
                            			if (totalTime < 1000)
                            			{
                            				totalTime += 100;
    	                        			// button height must be 20 !!
    	                        			// css not yet loaded
    	                        			setTimeout(resize,100);
    	                        			return;
                            			}
                            			else
                            			{
                            				totalTime = 0;
                            			}
                            		}
                            		for (var i =0;i< iframe.parentNode.parentNode.childNodes.length;i++)
                            		{
                            			if (iframe.parentNode.parentNode.childNodes[i] != iframe.parentNode)
                            			{
                            				extractHeight += iframe.parentNode.parentNode.childNodes[i].offsetHeight;
                            			}
                            			else
                            			{
                            				// extract border,padding, margin... just hard code for now
                            				extractHeight +=3;
                            			}
                            		}
                            		var textarea = tinymce.DOM.get(ed.id);
                            		var container = textarea.parentNode;
                            		var resizeHeight = (container.offsetHeight - extractHeight) + 'px';
                            		var oldSize = tinymce.DOM.getStyle(iframe,'height');
                                    // Resize content element
                                    if (resizeHeight !== oldSize) {
                            				tinymce.DOM.setStyle(iframe, 'height', resizeHeight);
                                    };
                        		}	
                        };

                        // Add appropriate listeners for resizing 
                        ed.on('change', resize);
                        ed.on('show', resize);
                        ed.on('init', resize);
                        ed.on('LoadContent', resize);
                        // also recalculate on window resize
                        $(window).resize(resize);
                        // Register the command so that it can be invoked by using tinyMCE.activeEditor.execCommand('mceResizeToContainer');
                        ed.addCommand('mceResizeToContainer', resize);
                },

                getInfo : function() {
                        return {
                                longname : 'Resize to Container',
                                author : 'Laurian Vostinar',
                                authorurl : 'http://www.servoy.com',
                                version : tinymce.majorVersion + "." + tinymce.minorVersion
                        };
                }
        });

        // Register plugin
        tinymce.PluginManager.add('resizetocontainer', tinymce.plugins.ResizeToContainer);
})();